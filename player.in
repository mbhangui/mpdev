#!/bin/sh
#
# $Log: player.in,v $
# Revision 1.2  2020-07-13 01:04:53+05:30  Cprogrammer
# add stat entry without need for mpdev_update
#
# Revision 1.1  2020-07-08 10:59:46+05:30  Cprogrammer
# Initial revision
#
#
# $Id: player.in,v 1.2 2020-07-13 01:04:53+05:30 Cprogrammer Exp mbhangui $
#
get_TTindex()
{
    echo "SELECT TTindex FROM Tracktable WHERE Uri='$1';" | mysql -s -u rompr -promprdbpass -h pi4 romprdb 2>/dev/null
    if [ $? -ne 0 ] ; then
        echo "SELECT TTindex FROM Tracktable WHERE Uri='$1';" 1>&2
        return 1
    fi
}

get_mpd_conf_value()
{
    grep "^$1" /etc/mpd.conf|awk '{print $2}' | \
    sed -e 's{"{{g'
}

get_mpd_rating()
{
    uri=`echo $1|sed -e "s{'{''{g"`
	sqlite3 -batch $sticker_file "SELECT value from sticker where type='song' and uri='$uri';"
    if [ $? -ne 0 ] ; then
        echo "error: SELECT value from sticker where type='song' and uri=\"$uri\";" 1>&2
        return 1
    fi
}

insert_sticker()
{
    uri=`echo $1|sed -e "s{'{''{g"`
	rating=$2
	sqlite3 -batch $sticker_file "INSERT or IGNORE into sticker values('song', '$uri', 'rating', $rating);"
    if [ $? -ne 0 ] ; then
		echo "error: INSERT into sticker values('song', '$uri', 'rating',$rating);" 1>&2
        return 1
    fi
}

update_sticker()
{
    uri=`echo $1|sed -e "s{'{''{g"`
	rating=$2
	sqlite3 -batch $sticker_file "UPDATE sticker set value=$rating where type='song' and uri='$uri';"
    if [ $? -ne 0 ] ; then
        echo "error: UPDATE sticker set value=$rating where type='song' and uri='$uri';" 1>&2
        return 1
    fi
}

insert_stats()
{
	# SONG_LAST_MODIFIED: last_modified
	# SONG_ALBUM: album
	# SONG_ARTIST: artist
	# SONG_DATE: date
	# SONG_GENRE: genre
	# SONG_TITLE: title
	# SONG_TRACK: track
	# SONG_DURATION: duration

	last_played=$1
    uri=`echo "$2" | sed -e "s{'{''{g"`
	ARTIST=`echo "$SONG_ARTIST" | sed -e "s{'{''{g"`
	ALBUM=`echo "$SONG_ALBUM" | sed -e "s{'{''{g"`
	TITLE=`echo "$SONG_TITLE" | sed -e "s{'{''{g"`
	rating=$3
	sqlite3 -batch $music_dir/.mpd/stats.db "INSERT or IGNORE into \
		song (uri, play_count, last_played, rating, duration,last_modified,artist,album,title,track,genre,date) \
		values ('$uri',0,$last_played,$rating,$SONG_DURATION,$SONG_LAST_MODIFIED,'$ARTIST','$ALBUM','$TITLE','$SONG_TRACK','$SONG_GENRE','$SONG_DATE');"
    if [ $? -ne 0 ] ; then
		echo "error: \"INSERT or IGNORE into song (uri, play_count, last_played, rating, duration,last_modified,artist,album,title,track,genre,date) values ('$uri',0,$last_played,$rating,$SONG_DURATION,$SONG_LAST_MODIFIED,'$ARTIST','$ALBUM','$TITLE','$SONG_TRACK','$SONG_GENRE','$SONG_DATE');\"" 1>&2
        return 1
	fi
}

mpdev_update()
{
	last_played=$1
    uri=`echo "$2" | sed -e "s{'{''{g"`
	rating=$3
	sqlite3 -batch $music_dir/.mpd/stats.db "UPDATE song set last_played=$last_played,play_count=play_count+1,rating=$rating where uri='$uri';"
    if [ $? -ne 0 ] ; then
        echo "ERROR: UPDATE song set last_played=$1,rating=$3 where uri='$uri';" 1>&2
        return 1
    fi
}

update_rompr()
{
    uri=$(echo "$1" | sed s/"'"/"\\\'"/g)
    rating=`expr "$2" / 2`
    TTindex=`get_TTindex "$uri"`
    if [ -n "$TTindex" ] ; then
        (
        echo -n "INSERT into Playcounttable (TTindex, Playcount, LastPlayed) "
        echo -n "VALUES ($TTindex,1, NOW()) ON DUPLICATE "
        echo -n "KEY UPDATE Playcount=Playcount+1, LastPlayed=NOW();"
        echo
        echo -n "INSERT INTO Ratingtable (TTindex, Rating) VALUES ($TTindex, $rating) "
        echo -n "ON DUPLICATE KEY UPDATE Rating = $rating, zztimestamp=NOW();"
        echo
        ) | mysql -s -u rompr -promprdbpass -h pi4 romprdb 2>/dev/null
        if [ $? -ne 0 ] ; then
            (
            echo -n "INSERT into Playcounttable (TTindex, Playcount, LastPlayed) "
            echo -n "VALUES ($TTindex,1, NOW()) ON DUPLICATE "
            echo -n "KEY UPDATE Playcount=Playcount+1, LastPlayed=NOW();"
            echo
            echo -n "INSERT INTO Ratingtable (TTindex, Rating) VALUES ($TTindex, $rating) "
            echo -n "ON DUPLICATE KEY UPDATE Rating = $rating, , zztimestamp=NOW();"
            echo
            ) 1>&2
            return 1
        fi
    fi
}

update_song()
{
	uri="$1"
    tmval=`date +'%s'`
	rating=`get_mpd_rating "$uri"`
	if [ -z "$rating" ] ; then
		rating=6 # assign average rating of 3 for unrated music
		echo "INSERT sticker tmval=$tmval rating=$rating song=[$1]"
		insert_sticker "$uri" "$rating"
	fi
	if [ $rating -eq 0 ] ; then
		rating=6;
		echo "UPDATE sticker tmval=$tmval rating=$rating song=[$1]"
		update_sticker "$uri" "$rating"
	fi
	if [ $# -eq 2 ] ; then
		echo "EndSong stat   tmval=$tmval rating=$rating song=[$1]"
		mpdev_update $tmval "$uri" "$rating"
	else
		echo "NewSong stat   tmval=$tmval rating=$rating song=[$1]"
		insert_stats 0 "$uri" "$rating"
		update_rompr "$uri" "$rating"
	fi
}

if [ -z "$VERBOSE" ] ; then
	VERBOSE=0
fi
if [ -n "$SONG_TITLE" ] ; then
	music_dir=`get_mpd_conf_value music_directory`
	if [ $? -ne 0 ] ; then
    	echo "could not get music directory from mpd.conf" 1>&2
    	exit 1
	fi
	sticker_file=`get_mpd_conf_value sticker_file`
	if [ $? -ne 0 ] ; then
    	echo "could not get sticker database from mpd.conf" 1>&2
    	exit 1
	fi
	if [ " $1" = " end-song" ] ; then
		update_song "$SONG_URI" "stats"
	else
		update_song "$SONG_URI"
		if [ -f /tmp/MPD_SONG_URI ] ; then
			MYSONG_URI=`sed -n 1p /tmp/MPD_SONG_URI`
			TIME_VAL=`sed -n 2p /tmp/MPD_SONG_URI`
			TIME_DUR=`sed -n 3p /tmp/MPD_SONG_URI`
			if [ -n "$MYSONG_URI" -a ! "$MYSONG_URI" = "$SONG_URI" ] ; then
				if [ $VERBOSE -eq 2 ] ; then
					echo lastfm-scrobbler --update --artist="$SONG_ARTIST" --album="$SONG_ALBUM" --track="$SONG_TITLE"  --duration="$SONG_DURATION"
				fi
				if [ $VERBOSE -eq 0 -o $VERBOSE -eq 1 ] ; then
					lastfm-scrobbler --update --artist="$SONG_ARTIST" \
						--album="$SONG_ALBUM" --track="$SONG_TITLE" \
						--duration="$SONG_DURATION" > /dev/null
				else
					lastfm-scrobbler --update --artist="$SONG_ARTIST" \
						--album="$SONG_ALBUM" --track="$SONG_TITLE" \
						--duration="$SONG_DURATION"
				fi
				if [ $VERBOSE -eq 2 ] ; then
					echo librefm-scrobbler --update --artist="$SONG_ARTIST" --album="$SONG_ALBUM" --track="$SONG_TITLE"  --duration="$SONG_DURATION" 
				fi
				if [ $VERBOSE -eq 0 -o $VERBOSE -eq 1 ] ; then
					librefm-scrobbler --update --artist="$SONG_ARTIST" \
						--album="$SONG_ALBUM" --track="$SONG_TITLE" \
						--duration="$SONG_DURATION" > /dev/null
				else
					librefm-scrobbler --update --artist="$SONG_ARTIST" \
						--album="$SONG_ALBUM" --track="$SONG_TITLE" \
						--duration="$SONG_DURATION"
				fi
			fi
			/bin/rm -f /tmp/MPD_SONG_URI
		else
			if [ $VERBOSE -eq 2 ] ; then
				echo lastfm-scrobbler --update --artist="$SONG_ARTIST" --album="$SONG_ALBUM" --track="$SONG_TITLE"  --duration="$SONG_DURATION"
			fi
			if [ $VERBOSE -eq 0 -o $VERBOSE -eq 1 ] ; then
				lastfm-scrobbler --update --artist="$SONG_ARTIST" \
					--album="$SONG_ALBUM" --track="$SONG_TITLE" \
					--duration="$SONG_DURATION" > /dev/null
			else
				lastfm-scrobbler --update --artist="$SONG_ARTIST" \
					--album="$SONG_ALBUM" --track="$SONG_TITLE" \
					--duration="$SONG_DURATION"
			fi
			if [ $VERBOSE -eq 2 ] ; then
				echo librefm-scrobbler --update --artist="$SONG_ARTIST" --album="$SONG_ALBUM" --track="$SONG_TITLE"  --duration="$SONG_DURATION" > /dev/null
			fi
			if [ $VERBOSE -eq 0 -o $VERBOSE -eq 1 ] ; then
				librefm-scrobbler --update --artist="$SONG_ARTIST" \
					--album="$SONG_ALBUM" --track="$SONG_TITLE" \
					--duration="$SONG_DURATION" > /dev/null
			else
				librefm-scrobbler --update --artist="$SONG_ARTIST" \
					--album="$SONG_ALBUM" --track="$SONG_TITLE" \
					--duration="$SONG_DURATION"
			fi
		fi
		(
    		tmval=`date +'%s'`
			echo "$SONG_URI"
			echo "$tmval"
			echo "$SONG_DURATION"
		) > /tmp/MPD_SONG_URI
	fi
fi
if [ $VERBOSE -gt 0 ] ; then
	(
	env | egrep "^SONG_|^MPD_|^VERBOSE"
	echo -------------------------
	) >> /tmp/player.env
fi
exit 0
